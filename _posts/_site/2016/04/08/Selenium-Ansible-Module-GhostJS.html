
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Using Selenium and Ghostdriver as an Ansible Module</title>
    <meta name="description" content="Utilizing Selenium and PhantomJS as an Ansible Module for configuration or testing">
    <meta name="author" content="James Whetsell">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">zer0glitch</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

    <div class="container-narrow">


<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>08 April 2016</span>
    </div>
    <div class="content">
      <p>Ansible is farily flexable and extensible when for automation tool that can be extended through the use of custom modules.  This post will walk through the steps of using Selenium Web Driver scripts generated through the Mozilla plugin, to modify that into an ansible module, to do a web based configuration.</p>

<p>This project will have all code available in the example repoistory on github.  Here are the requirements for getting started:</p>

<h1 id="initial-setup">Initial Setup</h1>

<p><strong>Downloads</strong></p>

<ul>
  <li><a href="http://docs.ansible.com/ansible/intro_installation.html">Installing Ansible</a></li>
  <li><a href="https://addons.mozilla.org/en-US/firefox/addon/selenium-ide/">Installing Selenium Firefox Plugin</a></li>
  <li>
    <p><a href="http://phantomjs.org/download.html">Installing PhantomJS</a></p>
  </li>
  <li>Install EPEL Repo</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm

</code></pre>
</div>

<ul>
  <li>Install the support files</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>yum install sshpass python-pip pycrypto -y
pip install ansible

</code></pre>
</div>

<ul>
  <li>Selenium Install</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>pip install selenium

</code></pre>
</div>

<ul>
  <li>Installing PhantomJS</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>wget -P /tmp https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-2.1.1-linux-x86_64.tar.bz2
cd /tmp
bunzip2 phantomjs-2.1.1-linux-x86_64.tar.bz2
tar xvf phantomjs-2.1.1-linux-x86_64.tar
cp phantomjs-2.1.1-linux-x86_64/bin/phantomjs /usr/local/bin
chmod 755 /usr/local/bin/phantomjs

</code></pre>
</div>

<h1 id="generating-your-selenium-script">Generating your Selenium Script</h1>

<ul>
  <li>Open Firefox and Launch the Selenium IDE</li>
  <li>Click the record button</li>
  <li>goto: http://localhost/samtest/index.jsp</li>
  <li>Enter any value in the name field</li>
  <li>Click submit</li>
  <li>Goto file –&gt; Export –&gt; python2 web driver</li>
</ul>

<p>The defautl script will be setup to run an open instance of Firefox.  Later when we modify the script will change it to use PhantomJS, so this can be integrated into a CICD process.</p>

<h1 id="exam-the-saved-script-and-convert-to-an-ansible-module">Exam the saved script and convert to an ansible module</h1>
<ol>
  <li>Create a directory called library under your base playbooks</li>
  <li>Copy the generated script to the directory</li>
  <li>Make modifications into an ansible module</li>
</ol>

<ul>
  <li>We add the path to</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/python</span>

<span class="c"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.by</span> <span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.keys</span> <span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.support.ui</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">NoSuchElementException</span>
<span class="kn">from</span> <span class="nn">selenium.common.exceptions</span> <span class="kn">import</span> <span class="n">NoAlertPresentException</span>
<span class="kn">import</span> <span class="nn">unittest</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span>

</code></pre>
</div>

<ul>
  <li>Add Ansible Inport modules</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code># Add Ansible Inport modules
from ansible.module_utils.basic import *

</code></pre>
</div>

<ul>
  <li>Change the Example module from a unit test a standard class</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>#class ExampleModule(unittest.TestCase):
class ExampleModule():

</code></pre>
</div>

<ul>
  <li>Change the init to add the parameters we need and intiialize object variables</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    def __init__(self, server, cert, certkey, certpass, creates):
        self.server = server
        self.creates = creates
        self.cert = cert
        self.certkey = certkey
        self.certpass = certpass

</code></pre>
</div>
<ul>
  <li>make the setup of our driver part of the init for the object</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>#    def setUp(self):

</code></pre>
</div>

<ul>
  <li>Comment out the web driver for firefox and add the driver for PhantomJS</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>        #self.driver = webdriver.Firefox()
        self.driver = webdriver.PhantomJS(executable_path="/usr/local/bin/phantomjs")
</code></pre>
</div>

<ul>
  <li>The arguments below will allow you to connect to PKI proected or self generated certificate server</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>		#,service_args=['--ignore-ssl-errors=yes',
                #'--ssl-client-certificate-file=' + self.cert, 
                #'--ssl-client-key-file=' + self.certkey,
                #'--ssl-client-key-passphrase=' + self.certpass])

        self.driver.set_window_size(1120, 550)
        self.driver.implicitly_wait(30)
        self.base_url = "https://" + self.server
        self.verificationErrors = []
        self.accept_next_alert = True
    
    def config_service(self):
        changed = True
        success = True
        errors = []
        changes = []
</code></pre>
</div>

<ul>
  <li>We add logic to not run if the file we have created already exists</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>        if not os.path.exists(self.creates):
            try:
</code></pre>
</div>
<ul>
  <li>The section below is going to be used for the actual interaction, you need to replace specifics with generics where necessary</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>                driver = self.driver
                driver.get(self.base_url + "/example_module/web/")
                driver.find_element_by_id("password").clear()
                driver.find_element_by_id("password").send_keys("example_module")
                driver.find_element_by_id("username").clear()
                driver.find_element_by_id("username").send_keys("admin")
                driver.find_element_by_xpath("//button[@type='submit']").click()
                driver.find_element_by_link_text("Add stores").click()
                #driver.find_element_by_css_selector("#id5 &gt; ul &gt; li &gt; div &gt; a &gt; span").click()
                driver.find_element_by_xpath("//form/ul/li/div/a/span").click()
                driver.find_element_by_name("parametersPanel:parameters:2:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:2:parameterPanel:border:paramValue").send_keys("admin")
                driver.find_element_by_name("parametersPanel:parameters:3:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:3:parameterPanel:border:paramValue").send_keys("example_module")
                driver.find_element_by_name("dataStoreNamePanel:border:paramValue").clear()
                driver.find_element_by_name("dataStoreNamePanel:border:paramValue").send_keys("tcri_ais_so")
                driver.find_element_by_name("parametersPanel:parameters:0:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:0:parameterPanel:border:paramValue").send_keys("tcri")
                driver.find_element_by_name("parametersPanel:parameters:1:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:1:parameterPanel:border:paramValue").send_keys("zoo1,zoo2,zoo3")
                driver.find_element_by_name("parametersPanel:parameters:2:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:2:parameterPanel:border:paramValue").send_keys("tcri_rw")
                driver.find_element_by_name("parametersPanel:parameters:3:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:3:parameterPanel:border:paramValue").send_keys("spawarinstall")
                driver.find_element_by_name("parametersPanel:parameters:4:parameterPanel:border:paramValue").clear()
                driver.find_element_by_name("parametersPanel:parameters:4:parameterPanel:border:paramValue").send_keys("geomesa")
                #driver.find_element_by_id("id9").click()
                driver.find_element_by_link_text("Save").click()
                driver.find_element_by_xpath("//span/a/span").click()
                driver.find_element_by_id("minX").clear()
                driver.find_element_by_id("minX").send_keys("-180")
                driver.find_element_by_id("minY").clear()
                driver.find_element_by_id("minY").send_keys("-90")
                driver.find_element_by_id("maxX").clear()
                driver.find_element_by_id("maxX").send_keys("180")
                driver.find_element_by_id("maxY").clear()
                driver.find_element_by_id("maxY").send_keys("90")
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:minX").clear()
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:minX").send_keys("-180")
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:minY").clear()
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:minY").send_keys("-90")
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:maxX").clear()
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:maxX").send_keys("180")
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:maxY").clear()
                driver.find_element_by_name("tabs:panel:theList:0:content:referencingForm:latLonBoundingBox:maxY").send_keys("90")
                driver.find_element_by_link_text("Save").click()
</code></pre>
</div>

<ul>
  <li>Add a changed message here.  It is possible to add mutliple messages to display back in the ansible script</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>                changes.append("Added ais_oth_so layer")
</code></pre>
</div>

<ul>
  <li>We will catch exceptions here and add error messages</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>            except Exception as e:
		# Set success to false for ansible notification
                success = False
		# Set changed to false for ansible notification
                changed = False
		# append the error stack
                errors.append("ERROR: ------------ " + str(e))
</code></pre>
</div>

<ul>
  <li>if there are no errors create the creates dir</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>        if len(errors) == 0 and len(self.creates) != 0:
            if os.path.exists(self.creates):
                os.utime(self.creates, None)
            else:
                open(self.creates, 'a').close()
</code></pre>
</div>

<ul>
  <li>return back a new dictionary, ansible will use this as part of its return</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>        return dict(success=success, changed=changed, changes=changes, errors=errors, msg=", ".join(errors))
</code></pre>
</div>

<ul>
  <li>It is always import to close down the phatomjs browser, just because you don’t see it, doesn’t meant it isn’t running</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    def tearDown(self):
        self.driver.quit()
</code></pre>
</div>

<ul>
  <li>Create our own main method</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>def main():
</code></pre>
</div>
<ul>
  <li>this is commented out for testing purporses.  If you want to test outside of ansible then uncomment this ling and comemnt the rest of the main method</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    #example_module = ExampleModule("172.26.14.35:8443", "./c3test_u_fouo.crt.pem", "./c3test_u_fouo.key.pem", "pass", "/tmp/geosotest")
</code></pre>
</div>

<ul>
  <li>initialize the return value, by default we are goign to say everythign worked ok</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    returnVal = dict(succes=True)
</code></pre>
</div>

<ul>
  <li>We are defining each of the arguments that will be passed from the playbook here</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    BASE_MODULE_ARGS = dict(
        server = dict(required=True),
        creates = dict(default=""),
        cert = dict(required=True),
        certkey = dict(required=True),
        certpass = dict(required=True)
    )
</code></pre>
</div>
<ul>
  <li>Define the module we will be calling here</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    module = AnsibleModule(
        argument_spec= BASE_MODULE_ARGS,
        supports_check_mode=True
    )
</code></pre>
</div>

<ul>
  <li>We are now creating an instance of the python object, using the parameters that are pulled from above</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    example_module = ExampleModule(
        module.params["server"],
        module.params["cert"],
        module.params["certkey"],
        module.params["certpass"],
        module.params["creates"]
    )
</code></pre>
</div>

<ul>
  <li>try to call our test method, you can also add if statements based upon parameters here</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>
    try:
        returnVal = example_module.test_geo_config()
</code></pre>
</div>
<ul>
  <li>if there is an exception in the method exit the module with the error</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    except Exception as e:
        module.fail_json(msg=str(e))
</code></pre>
</div>
<ul>
  <li>make sure the browser is closed</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    finally:
        example_module.tearDown()

</code></pre>
</div>
<ul>
  <li>return with success if everything changed ok, otherwise exit with the error message</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>    if (returnVal['changed'] == True):
        module.exit_json(**returnVal)
    else:
        module.fail_json(msg=returnVal['msg'])
</code></pre>
</div>
<ul>
  <li>try to call our test method, you can also add if statements based upon parameters here</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code># this is magic, see lib/ansible/module_common.py
# #&lt;&lt;INCLUDE_ANSIBLE_MODULE_COMMON&gt;&gt;
if __name__ == "__main__":
    main()
</code></pre>
</div>

<ul>
  <li>comment out the unit test that would have been used for testing</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>#    unittest.main()
</code></pre>
</div>

<h1 id="actually-using-selenium-and-python-for-testing">Actually Using selenium and python for testing</h1>

<p>In another article we will talk about automated testing instead of configuration with the same tool set</p>

<h1 id="download-full-example">Download full example</h1>
<p><a href="http://zer0glitch.githbu.com/zer0glitch/">http://zer0glitch.githbu.com/zer0glitch/</a></p>

    </div>

    

    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev disabled"><a>&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2016/07/08/Vagrant-Libvirt-Clusters" title="Using vagrant and kvm/libvirt for clustered development environments">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2016 James Whetsell
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
        </p>
      </footer>

    </div>

    




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123-12']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




  </body>
</html>

