
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Using vagrant and kvm/libvirt for clustered development environments</title>
    <meta name="description" content="Using vagrant and kvm/libvirt for clustered development environments">
    <meta name="author" content="James Whetsell">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">zer0glitch</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        

    <div class="container-narrow">


<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>08 July 2016</span>
    </div>
    <div class="content">
      <h1 id="initial-setup">Initial Setup</h1>

<p><strong>Installation</strong></p>

<ul>
  <li><a href="http://docs.ansible.com/ansible/intro_installation.html">Installing Ansible</a></li>
  <li><a href="https://galaxy.ansible.com/zer0glitch/vagrant-libvirt/">Installing Ansible libvirt/kvm/Ansible</a></li>
  <li>
    <p><a href="https://github.com/zer0glitch/vagrant-cluster-example">Full Example</a></p>
  </li>
  <li>Install EPEL Repo</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm
</code></pre>
</div>

<h1 id="testing-the-vagrant-configuration">Testing the Vagrant configuration</h1>

<p>For this test we will be using a standard base box. <a href="https://atlas.hashicorp.com/centos/boxes/7/">Box info</a></p>

<p><strong>Initialize the box</strong>
This will download and stall the basebox on the intialization from the vagrant host.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant init centos/7
</code></pre>
</div>

<p><strong>Exam the Vagrantfile</strong></p>

<p>I have removed most of the comments and used parameters for our example, this will allow us to have a vagrant machien running Centos7, but before we do that, we need to define a strategry for defining libvirt as the provider.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|
  config.vm.box = "centos/7"
end
</code></pre>
</div>

<p>We have 3 options of defining the libvirt provider.</p>

<ol>
  <li>Utilize the â€“provider tag on the vagrant up command</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant up --provider=libvirt
</code></pre>
</div>

<ol>
  <li>Environment variable</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code>VAGRANT_DEFAULT_PROVIDER=libvirt;vagrant up
</code></pre>
</div>

<ol>
  <li>Confiration in our Vagrantfile.  This will specify the vagrant machine will only run on libvirt.  This may or may not be something you are looking for.  A developer may not be running libvirt, and need a Virtualbox default, but in a hosted environment, this may be the best method for standing up multiple machines.</li>
</ol>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|
  config.vm.box = "centos/7"

  # configures the machine for 
  config.vm.provider :libvirt do |libvirt|
    libvirt.nested = true
    libvirt.driver = "kvm"
  end
end
</code></pre>
</div>

<p><strong>Starting the Vagrant box to test</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant up
</code></pre>
</div>

<p>SSH to the machine and make sure everything is up</p>

<div class="highlighter-rouge"><pre class="highlight"><code>virsh list 
</code></pre>
</div>
<p>You should see a VM running start with the name of the directory that you started in.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant ssh
sudo -i
</code></pre>
</div>

<p>This should give you a root prompt on your VM.</p>

<p><strong>Setting up a cluster</strong></p>

<p>First we must down the VM by running</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant halt
</code></pre>
</div>

<p>Since Vagrant is based on ruby we can run a ruby loop to create multiple VMs inside of our Vagrant file.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|

  # We are going to create 3 VMs
  (1..3).each do |i|

    # set a name for the VM
    vm_name="Server#{i}"

    config.vm.define vm_name do |node|
      node.vm.box = "centos/7"
    end
  end

  # configures the machine for 
  config.vm.provider :libvirt do |libvirt|
    libvirt.nested = true
    libvirt.driver = "kvm"
  end
end
</code></pre>
</div>

<p><strong>Starting the Vagrant box to test</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant up
</code></pre>
</div>

<p><strong>Check the VM</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>virsh list
</code></pre>
</div>

<p>You should see 3 servers running like the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>101   test_Server3                  running
102   test_Server1                  running
103   test_Server2                  running
</code></pre>
</div>

<p>Running a <code class="highlighter-rouge">vagrant status</code> will also give you information about the running VMs.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@localhost test]# vagrant status
Current machine states:

Server1                  running (libvirt)
Server2                  running (libvirt)
Server3                  running (libvirt)

This environment represents multiple VMs. The VMs are all listed
above with their current state. For more information about a specific
VM, run `vagrant status NAME`.
</code></pre>
</div>

<p>Now if we try to access the machines with a <code class="highlighter-rouge">vagrant ssh</code> we will get the following error:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>This command requires a specific VM name to target in a multi-VM environment.
</code></pre>
</div>

<p>We can access the VMs with the following, and see the hostname of the server:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[root@localhost test]# vagrant ssh Server1
[vagrant@localhost ~]$ hostname
localhost.localdomain
</code></pre>
</div>

<p>Let us give the machine a better hostname so we can identify the machine better.</p>

<div class="highlighter-rouge"><pre class="highlight"><code> -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|

  # We are going to create 3 VMs
  (1..3).each do |i|

    # set a name for the VM
    vm_name="Server#{i}"

    config.vm.define vm_name do |node|
      node.vm.box = "centos/7"
      node.vm.hostname = vm_name
    end
  end

  # configures the machine for
  config.vm.provider :libvirt do |libvirt|
    libvirt.nested = true
    libvirt.driver = "kvm"
  end
end
</code></pre>
</div>

<p>Check the hostname of Server1</p>

<p>Running vagrant ssh with the -c option will allow us to run a command <code class="highlighter-rouge">vagrant ssh Server1 -c hostname</code>, and we should see a result like this.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server1
Connection to 192.168.121.208 closed.
</code></pre>
</div>

<p>Now we can work on a more complex example.  We are going to create a single database server and two web servers.  Our configuration will be as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Two Web Servers:
- httpd
- postgres client

One Database Server
- postgres server/client
</code></pre>
</div>

<p>To accomplish this we are going to have multipe configuration sections. Our result Vagrant file looks like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|


  # Configure the Single Database server
  config.vm.define "database" do |node|
    node.vm.box = "centos/7"
    node.vm.hostname = "database"
  end

  # We are going to create 3 VMs
  (1..2).each do |i|

    # set a name for the VM
    vm_name="web#{i}"

    config.vm.define vm_name do |node|
      node.vm.box = "centos/7"
      node.vm.hostname = vm_name
    end
  end

  # configures the machine for
  config.vm.provider :libvirt do |libvirt|
    libvirt.nested = true
    libvirt.driver = "kvm"
  end
end
</code></pre>
</div>

<p>So we have made our life easier.  We have started with a preconfigured VM, so no waiting for the installation to complete, we have the VMs stood up in the matter of mintunes and now we are ready to provision the machine.  This is an additional power of Vagrant.  We can automaticall provision and configure our machines.  We will be using the ansible provisioner.  To conigure the servers with the roles they need.</p>

<p>Sample playbooks can be downloaded from <a href="https://github.com/zer0glitch/vagrant-cluster-example">here</a>.</p>

<p>The vagrant file will be modified to do the following things:
- Add provisioning sections for the servers
- create server groups</p>

<p><strong>New Vagrant file</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code># -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure(2) do |config|

  # The web servers
  web_servers = []

  # Configure the Single Database server
  config.vm.define "database" do |node|
    node.vm.box = "centos/7"
    node.vm.hostname = "database"
  end

  # We are going to create 3 VMs
  (1..2).each do |i|

    # set a name for the VM
    vm_name="web#{i}"

    # add the server to web server list
    web_servers.push(vm_name)

    config.vm.define vm_name do |node|
      node.vm.box = "centos/7"
      node.vm.hostname = vm_name
    end
  end

  config.vm.provision :ansible do |ansible|
    ansible.groups = {
      "database" =&gt; ["database"],
      "webservers" =&gt; web_servers,
    }
    ansible.playbook = "site.yml"
    ansible.verbose = true
    ansible.sudo = true
    ansible.limit = "all"
  end


  # configures the machine for 
  config.vm.provider :libvirt do |libvirt|
    libvirt.nested = true
    libvirt.driver = "kvm"
  end

end
</code></pre>
</div>

<p><strong>database.yml</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>---
- hosts: database
  tasks:

  - yum: name=postgresql-server state=installed
</code></pre>
</div>

<p><strong>web.yml</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>---
- hosts: webservers
  tasks:

  - yum: name=postgresql state=installed
  - yum: name=httpd state=installed
</code></pre>
</div>

<h1 id="potential-errors">Potential Errors:</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>An error occurred while executing multiple actions in parallel.
</code></pre>
</div>

<p>To workaround this issue, bring the boxes with the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>vagrant up --no-parallel
</code></pre>
</div>

    </div>

    

    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2016/04/08/Selenium-Ansible-Module-GhostJS" title="Using Selenium and Ghostdriver as an Ansible Module">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/2016/07/12/Packer-QEMU-errors" title="Packer QEMU Error">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2016 James Whetsell
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
        </p>
      </footer>

    </div>

    




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-123-12']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>




  </body>
</html>

